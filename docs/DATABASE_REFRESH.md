# Database Refresh Workflow

This is the recommended workflow for refreshing your database and seeding it with common verses.

## Step-by-Step

### 1. Apply Migrations

Apply all migrations in order using Supabase:

```sql
-- In Supabase SQL Editor, run in order:
-- 000_main_schema.sql
-- 001_auth_schema.sql (if using auth)
-- 001_improvements.sql
-- 002_bible_version.sql
-- 003_auto_import_fields.sql
-- 004_bonus_records.sql
-- 005_fix_points_view.sql
-- 006_add_total_earned.sql
-- 007_add_emoji_icon.sql
-- 009_consolidated_user_points_summary.sql
-- 010_normalize_references.sql
```

Or if using Supabase CLI:
```bash
supabase db reset  # Resets and applies all migrations
```

### 2. Set Default Settings

Insert default settings (if not already done):

```sql
INSERT INTO settings (default_points_first, default_points_repeat, bible_version)
VALUES (10, 5, 'NIV')
ON CONFLICT DO NOTHING;
```

### 3. Seed Common Verses

Now run the verse seeding script:

```bash
cd web
npm run seed:verses
```

**What this does:**
- Fetches ~30 common verses from the Bible API
- Creates them with NIV text
- Uses your settings for default points
- **Creates verses exactly as if a user added them through the UI**

### 4. Verify

Check in Supabase or your app:

```sql
SELECT reference, bible_version, points_first, points_repeat, active 
FROM memory_items 
ORDER BY reference;
```

You should see ~30 verses, all with:
- `bible_version` = 'NIV'
- `active` = true
- Points from your settings (default: 10/5)
- All the same fields as user-created verses

## Database Fields Used

The seed script creates verses with **identical fields** to the UI:

```javascript
{
  type: 'verse',
  reference: 'John 3:16',        // Normalized reference
  text: '...',                   // Fetched from Bible API
  points_first: 10,              // From settings table
  points_repeat: 5,              // From settings table
  active: true,
  bible_version: 'NIV',
  // Auto-generated by database:
  id: '...',
  created_at: '...',
  updated_at: '...'
}
```

## Optional: Create Test Users

If you want to add some test users too:

```bash
cd web
node scripts/create-user.js
```

Or via SQL:

```sql
INSERT INTO users (name, is_leader, "emojiIcon") VALUES
  ('Alice', false, 'ðŸŒŸ'),
  ('Bob', false, 'ðŸš€'),
  ('Charlie', false, 'ðŸŽ¨');
```

## Troubleshooting

### "Missing Supabase credentials"
Make sure `web/.env.local` has:
```env
NEXT_PUBLIC_SUPABASE_URL=your_url
SUPABASE_SERVICE_ROLE_KEY=your_key
BIBLE_API_KEY=your_api_bible_key  # For NIV
```

### "Error: relation 'memory_items' does not exist"
Run migrations first (step 1)

### "Error: relation 'settings' does not exist"
Run migrations first (step 1)

### Verses showing as KJV instead of NIV
Add `BIBLE_API_KEY` to `web/.env.local` - without it, script uses free API (KJV only)

## Clean Slate

To start completely fresh:

```sql
-- WARNING: This deletes ALL data!
TRUNCATE memory_items, verse_records, spend_records, bonus_records, users, settings CASCADE;
```

Then follow steps 1-4 above.
